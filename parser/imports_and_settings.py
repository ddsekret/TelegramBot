# parser/imports_and_settings.py
import re
import logging
from datetime import datetime, timedelta
from typing import Dict, Optional, Tuple
import csv
from io import StringIO

# Настройка логирования
logging.basicConfig(level=logging.DEBUG)
logging.getLogger("urllib3").setLevel(logging.WARNING)
logger = logging.getLogger(__name__)

# Разрешённые буквы для номеров
ALLOWED_LETTERS = set("АВЕКМНОРСТУХ")

# Коды регионов РФ
REGION_CODES = {
    "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17",
    "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35",
    "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53",
    "54", "55", "56", "57", "58", "59", "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71",
    "72", "73", "74", "75", "76", "77", "78", "79", "80", "81", "82", "83", "84", "85", "86", "87", "88", "89",
    "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", "102", "113", "116", "121", "123", "124", "125",
    "126", "134", "136", "138", "142", "147", "150", "152", "154", "159", "161", "163", "164", "173", "174", "177",
    "178", "186", "190", "193", "196", "197", "198", "199", "277", "299", "716", "750", "763", "777", "799"
}

# Загрузка данных подразделений
SUBDIVISIONS = {
    "070-007": {
        "region": "Кабардино-Балкария",
        "subdivision": "Отделом УФМС России по Кабардино-Балкарской Республике в Прохладненском р-не"
    },
    "770-025": {"region": "Москва", "subdivision": "ОВД Центральный район"},
    "780-001": {"region": "Санкт-Петербург", "subdivision": "ОВД Центральный район"},
    "503-094": {"region": "Московская область", "subdivision": "ОВД Ленинский район"}
}
csv_data = """Код подразделения,Регион,Подразделение
500-000,Московская область,ОВД Советский район
780-001,Санкт-Петербург,ОВД Центральный район
660-002,Свердловская область,ОВД Центральный район
020-003,Башкортостан,ОВД Ленинский район
770-004,Москва,ОВД Кировский район
660-005,Свердловская область,ОВД Ленинский район
770-006,Москва,ОВД Советский район
780-007,Санкт-Петербург,ОВД Ленинский район
470-008,Ленинградская область,ОВД Октябрьский район
660-009,Красноярский край,ОВД Ленинский район
470-010,Ленинградская область,ОВД Ленинский район
500-011,Московская область,ОВД Кировский район
660-012,Красноярский край,ОВД Советский район
770-013,Москва,ОВД Ленинский район
780-014,Санкт-Петербург,ОВД Советский район
780-015,Санкт-Петербург,ОВД Ленинский район
500-016,Московская область,ОВД Октябрьский район
500-017,Московская область,ОВД Кировский район
610-018,Ростовская область,ОВД Кировский район
780-019,Санкт-Петербург,ОВД Центральный район
020-020,Башкортостан,ОВД Советский район
020-021,Башкортостан,ОВД Ленинский район
770-022,Москва,ОВД Октябрьский район
540-023,Новосибирская область,ОВД Советский район
660-024,Свердловская область,ОВД Кировский район
770-025,Москва,ОВД Центральный район
160-026,Татарстан,ОВД Октябрьский район
610-027,Ростовская область,ОВД Кировский район
780-028,Санкт-Петербург,ОВД Октябрьский район
020-029,Башкортостан,ОВД Октябрьский район
160-030,Татарстан,ОВД Центральный район
500-031,Московская область,ОВД Советский район
780-032,Санкт-Петербург,ОВД Советский район
540-033,Новосибирская область,ОВД Октябрьский район
470-034,Ленинградская область,ОВД Октябрьский район
160-035,Татарстан,ОВД Октябрьский район
660-036,Красноярский край,ОВД Центральный район
160-037,Татарстан,ОВД Советский район
780-038,Санкт-Петербург,ОВД Кировский район
020-039,Башкортостан,ОВД Кировский район
020-040,Башкортостан,ОВД Октябрьский район
780-041,Санкт-Петербург,ОВД Октябрьский район
770-042,Москва,ОВД Октябрьский район
160-043,Татарстан,ОВД Центральный район
160-044,Татарстан,ОВД Октябрьский район
770-045,Москва,ОВД Октябрьский район
660-046,Красноярский край,ОВД Советский район
470-047,Ленинградская область,ОВД Ленинский район
470-048,Ленинградская область,ОВД Советский район
470-049,Ленинградская область,ОВД Октябрьский район
540-050,Новосибирская область,ОВД Октябрьский район
660-051,Свердловская область,ОВД Центральный район
660-052,Свердловская область,ОВД Кировский район
160-053,Татарстан,ОВД Октябрьский район
660-054,Красноярский край,ОВД Советский район
660-055,Свердловская область,ОВД Октябрьский район
660-057,Свердловская область,ОВД Октябрьский район
660-058,Красноярский край,ОВД Кировский район
540-059,Новосибирская область,ОВД Кировский район
660-060,Красноярский край,ОВД Кировский район
020-061,Башкортостан,ОВД Октябрьский район
610-062,Ростовская область,ОВД Советский район
160-063,Татарстан,ОВД Центральный район
780-064,Санкт-Петербург,ОВД Советский район
470-065,Ленинградская область,ОВД Советский район
780-066,Санкт-Петербург,ОВД Центральный район
770-067,Москва,ОВД Центральный район
470-068,Ленинградская область,ОВД Кировский район
020-069,Башкортостан,ОВД Октябрьский район
160-070,Татарстан,ОВД Советский район
780-071,Санкт-Петербург,ОВД Ленинский район
660-072,Свердловская область,ОВД Октябрьский район
470-073,Ленинградская область,ОВД Октябрьский район
610-074,Ростовская область,ОВД Кировский район
610-075,Ростовская область,ОВД Ленинский район
660-076,Красноярский край,ОВД Центральный район
660-077,Красноярский край,ОВД Кировский район
540-078,Новосибирская область,ОВД Кировский район
500-079,Московская область,ОВД Кировский район
780-080,Санкт-Петербург,ОВД Центральный район
540-081,Новосибирская область,ОВД Советский район
020-082,Башкортостан,ОВД Кировский район
660-083,Красноярский край,ОВД Советский район
470-084,Ленинградская область,ОВД Центральный район
470-085,Ленинградская область,ОВД Ленинский район
780-086,Санкт-Петербург,ОВД Кировский район
470-087,Ленинградская область,ОВД Советский район
660-088,Свердловская область,ОВД Кировский район
020-089,Башкортостан,ОВД Ленинский район
660-090,Свердловская область,ОВД Кировский район
610-091,Ростовская область,ОВД Ленинский район
540-092,Новосибирская область,ОВД Ленинский район
540-093,Новосибирская область,ОВД Ленинский район
470-094,Ленинградская область,ОВД Ленинский район
020-095,Башкортостан,ОВД Октябрьский район
020-096,Башкортостан,ОВД Ленинский район
770-097,Москва,ОВД Советский район
780-098,Санкт-Петербург,ОВД Центральный район
500-099,Московская область,ОВД Ленинский район
070-007,Кабардино-Балкария,Отделом УФМС России по Кабардино-Балкарской Республике в Прохладненском р-не"""
csv_reader = csv.DictReader(StringIO(csv_data))
for row in csv_reader:
    SUBDIVISIONS[row["Код подразделения"]] = {
        "region": row["Регион"],
        "subdivision": row["Подразделение"]
    }

# Определение констант
valid_letters = set("АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ")

# Таблица транслитерации
CYRILLIC_TO_LATIN = {
    'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G', 'Д': 'D', 'Е': 'E', 'Ё': 'E',
    'Ж': 'ZH', 'З': 'Z', 'И': 'I', 'Й': 'Y', 'К': 'K', 'Л': 'L', 'М': 'M',
    'Н': 'N', 'О': 'O', 'П': 'P', 'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U',
    'Ф': 'F', 'Х': 'KH', 'Ц': 'TS', 'Ч': 'CH', 'Ш': 'SH', 'Щ': 'SCH', 'Ъ': '',
    'Ы': 'Y', 'Ь': '', 'Э': 'E', 'Ю': 'YU', 'Я': 'YA',
    'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'e',
    'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
    'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
    'ф': 'f', 'х': 'kh', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch', 'ъ': '',
    'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
}

# Словари для нормализации
CAR_BRANDS = {
    "volvo": "Volvo", "вольво": "Volvo", "волво": "Volvo",
    "scania": "Scania", "скания": "Scania",
    "man": "MAN", "ман": "MAN",
    "daf": "DAF", "даф": "DAF",
    "mercedes": "Mercedes-Benz", "mercedes-benz": "Mercedes-Benz",
    "mersedes-benz": "Mercedes-Benz", "мерседес": "Mercedes-Benz",
    "мерседес-бенз": "Mercedes-Benz",
    "iveco": "Iveco", "renault": "Renault",
    "kamaz": "Камаз", "камаз": "Камаз",
    "maz": "МАЗ", "маз": "МАЗ",
    "freightliner": "Freightliner", "kenworth": "Kenworth",
    "peterbilt": "Peterbilt", "isuzu": "Isuzu",
    "hino": "Hino", "mitsubishi": "Mitsubishi",
    "fuso": "Fuso", "tatra": "Tatra",
    "uaz": "УАЗ", "gaz": "ГАЗ",
    "zil": "ЗИЛ", "фотон": "Фотон",
}

TRAILER_BRANDS = {
    "schmitz": "Schmitz", "шмитц": "Schmitz", "шмиц": "Schmitz",
    "krone": "Krone", "крона": "Krone", "крон": "Krone",
    "kögel": "KÖGEL", "кёгель": "KÖGEL", "кёгел": "KÖGEL", "kogel": "KÖGEL",
    "schwarzmüller": "SCHWARZMÜLLER", "schwarzmuller": "SCHWARZMÜLLER",
    "wielton": "Wielton", "tonar": "Tonar", "grunwald": "Grunwald",
    "kässbohrer": "KÄSSBOHRER", "kassbohrer": "KÄSSBOHRER",
    "lamberet": "LAMBERET", "trailer": "TRAILER", "nefaz": "Nefaz",
}

COMPOSITE_CITIES = {
    "спб": "Санкт-Петербург", "санкт петербург": "Санкт-Петербург",
    "санкт-петербург": "Санкт-Петербург", "мск": "Москва",
    "нижний новгород": "Нижний Новгород", "усть-лабинск": "Усть-Лабинск",
    "каменск-уральский": "Каменск-Уральский",
    "каменск-шахтинский": "Каменск-Шахтинский",
    "новый уренгой": "Новый Уренгой", "старый оскол": "Старый Оскол",
    "великий новгород": "Великий Новгород",
    "кабардино-балкарской": "Кабардино-Балкарской",
    "прохладненском": "Прохладненском", "г.борисоглебск": "г. Борисоглебск",
    "г.санкт-петербург": "г. Санкт-Петербург",
    "приморско – ахтарского": "Приморско-Ахтарского",
    "приморско-ахтарского": "Приморско-Ахтарского",
    "ростове-на-дону": "Ростове-на-Дону",
    "ростов-на-дону": "Ростов-на-Дону",
    "пос.быково": "пос. Быково",
    "пос.затеречный": "пос. Затеречный",
}

CITY_NOMINATIVE = {
    "петрозаводске": "Петрозаводск",
    "москве": "Москва",
    "петербурге": "Санкт-Петербург",
    "борисоглебске": "Борисоглебск",
    "коломне": "Коломна",
    "екатеринбурге": "Екатеринбург",
    "барнауле": "Барнаул",
    "химки": "Химки",
}

SMALL_WORDS = {
    "по", "в", "на", "г.", "д.", "кор.", "лит.", "кв.", "р-он", "код", "под.", "и", "для", "с", "у", "к", "от",
    "до", "области", "краю", "административном", "округе", "города", "отделом", "отделением", "улица", "дом",
    "квартира", "район", "край", "пос.", "ул."
}

# Код региона по ОКАТО
OKATO_CODES = {
    "01": "Алтайский край", "02": "Башкортостан", "03": "Бурятия", "04": "Республика Алтай", "05": "Дагестан",
    "07": "Кабардино-Балкария", "08": "Калмыкия", "09": "Карачаево-Черкесия", "10": "Карелия", "11": "Коми",
    "12": "Марий Эл", "13": "Мордовия", "14": "Саха (Якутия)", "15": "Северная Осетия", "16": "Татарстан",
    "17": "Тыва", "18": "Удмуртия", "19": "Хакасия", "20": "Чечня", "21": "Чувашия", "22": "Красноярский край",
    "23": "Краснодарский край", "24": "Приморский край", "25": "Ставропольский край", "26": "Хабаровский край",
    "27": "Амурская область", "28": "Архангельская область", "29": "Астраханская область", "30": "Белгородская область",
    "31": "Брянская область", "32": "Владимирская область", "33": "Волгоградская область", "34": "Вологодская область",
    "35": "Воронежская область", "36": "Ивановская область", "37": "Иркутская область", "38": "Калининградская область",
    "39": "Калужская область", "40": "Кемеровская область", "41": "Кировская область", "42": "Костромская область",
    "43": "Курганская область", "44": "Курская область", "45": "Ленинградская область", "46": "Липецкая область",
    "47": "Магаданская область", "48": "Московская область", "49": "Мурманская область", "50": "Нижегородская область",
    "51": "Новгородская область", "52": "Новосибирская область", "53": "Омская область", "54": "Оренбургская область",
    "55": "Орловская область", "56": "Пензенская область", "57": "Пермский край", "58": "Псковская область",
    "59": "Ростовская область", "60": "Рязанская область", "61": "Самарская область", "62": "Саратовская область",
    "63": "Сахалинская область", "64": "Свердловская область", "65": "Смоленская область", "66": "Тамбовская область",
    "67": "Тверская область", "68": "Томская область", "69": "Тульская область", "70": "Тюменская область",
    "71": "Ульяновская область", "72": "Челябинская область", "73": "Ярославская область", "75": "Забайкальский край",
    "76": "Еврейская автономная область", "77": "Москва", "78": "Санкт-Петербург", "79": "Ненецкий автономный округ",
    "80": "Ханты-Мансийский автономный округ", "81": "Ямало-Ненецкий автономный округ", "82": "Чукотский автономный округ",
    "86": "Ханты-Мансийский АО"
}