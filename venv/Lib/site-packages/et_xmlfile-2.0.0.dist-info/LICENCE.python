import os
import re
import logging
import asyncio
import yadisk
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.fsm.state import State, StatesGroup
from aiogram.filters.state import StateFilter
from aiogram.fsm.context import FSMContext
from openpyxl import Workbook, load_workbook
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter
from datetime import datetime
from dotenv import load_dotenv
from aiogram.utils.markdown import hbold

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "8116572683:AAGxf2ttP-58uts18pRjTIy9cHX0LZfyUsU")
YANDEX_DISK_TOKEN = os.getenv("YANDEX_DISK_TOKEN", "y0__wgBELawpyAYkbY0IKiM5oQSstnwahr424ZzdNX_Y9dCWfPK-ac")
LOCAL_TEMP_DIR = "temp_files"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
storage = MemoryStorage()
bot = Bot(token=TELEGRAM_BOT_TOKEN)
dp = Dispatcher(storage=storage)
y_disk = yadisk.YaDisk(token=YANDEX_DISK_TOKEN)

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
os.makedirs(LOCAL_TEMP_DIR, exist_ok=True)

# –°–ª–æ–≤–∞—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
CAR_BRANDS = {
    "–¥–∞—Ñ": "DAF", "–≤–æ–ª—å–≤–æ": "Volvo", "–∫–∞–º–∞–∑": "–ö–∞–º–ê–ó", "–º–∞–∑": "MAZ",
    "—Å–∫–∞–Ω–∏—è": "Scania", "–º–µ—Ä—Å–µ–¥–µ—Å": "Mercedes", "–º–∞–Ω": "MAN", "—Ñ—Ä–µ–π—Ç–ª–∞–π–Ω–µ—Ä": "Freightliner",
    "–º–µ—Ä—Å–µ–¥–µ—Å-–±–µ–Ω—Ü": "Mercedes-Benz"
}

KEYWORDS_SYNONYMS = {
    "–§–∏—Ä–º–∞": ["—Ñ–∏—Ä–º–∞", "–∫–æ–º–ø–∞–Ω–∏—è", "—Ñ–∏—Ä–º–∞-–∑–∞–∫–∞–∑—á–∏–∫", "–∑–∞–∫–∞–∑—á–∏–∫", "—Ç–∫"],
    "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": ["–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–º–∞—Ä—à—Ä—É—Ç", "–ø—É—Ç—å", "—Ç—Ä–∞—Å—Å–∞"],
    "–í–æ–¥–∏—Ç–µ–ª—å": ["–≤–æ–¥–∏—Ç–µ–ª—å", "—à–æ—Ñ—ë—Ä", "—à–æ—Ñ–µ—Ä", "—Ñ.–∏.–æ.", "–∏–º—è"],
    "–ü–∞—Å–ø–æ—Ä—Ç": ["–ø–∞—Å–ø–æ—Ä—Ç", "–ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", "–ø–∞—Å–ø–æ—Ä—Ç —Ä—Ñ", "—Å–µ—Ä–∏—è", "–Ω–æ–º–µ—Ä"],
    "–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ": ["–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ", "–≤—É", "–≤/—É", "–≤.—É–¥.", "–ø—Ä–∞–≤–∞"],
    "–¢–µ–ª–µ—Ñ–æ–Ω": ["—Ç–µ–ª–µ—Ñ–æ–Ω", "–∫–æ–Ω—Ç–∞–∫—Ç", "–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", "—Ç–µ–ª.", "—Ç–µ–ª"],
    "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è": ["–¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è", "–¥.—Ä", "–¥.—Ä."],
    "–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏": ["–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", "–ø—Ä–æ–ø–∏—Å–∞–Ω –∏ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç", "–∞–¥—Ä–µ—Å", "–ø—Ä–æ–ø–∏—Å–∫–∞"],
    "–ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã": ["–º–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã", "–º–∞—à–∏–Ω–∞", "–∞–≤—Ç–æ", "–∞–≤—Ç–æ–º–æ–±–∏–ª—å", "–∞/–º", "—Ç—è–≥–∞—á", "—Ç—Å", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ"],
    "–ü—Ä–∏—Ü–µ–ø": ["–ø—Ä–∏—Ü–µ–ø", "–Ω–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞", "–ø–æ–ª—É–ø—Ä–∏—Ü–µ–ø", "–ø/–ø", "–ø/–ø—Ä.", "–ø/–ø—Ä"],
    "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫": ["–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫", "—ç–∫—Å–ø–µ–¥–∏—Ç–æ—Ä", "–≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫"],
    "–¶–µ–Ω–∞": ["—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Ç–∞—Ä–∏—Ñ"],
    "–û–ø–ª–∞—Ç–∞": ["–æ–ø–ª–∞—Ç–∞", "–ø–ª–∞—Ç–µ–∂", "–≤—ã–ø–ª–∞—Ç–∞"]
}

# –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
ALL_SYNONYMS = [syn.lower() for synonyms in KEYWORDS_SYNONYMS.values() for syn in synonyms]

class Form(StatesGroup):
    text_input = State()
    editing_field = State()

class ExcelManager:
    def __init__(self, base_dir):
        self.base_dir = base_dir
        self.current_month = datetime.now().strftime("%Y_%m")
        self.column_widths = {
            'daily': [15, 25, 25, 50, 25, 50, 25, 25, 15, 25, 15, 25, 15, 15, 15],
            'firms': [15, 25, 25, 50, 15, 18, 18],
            'carriers': [15, 25, 25, 50, 15, 18, 18, 15]
        }
        self.colors = {
            'header': 'FF4F81BD',
            'even_row': 'FFFFFFFF',
            'odd_row': 'FFF2F2F2'
        }

    def get_file_paths(self):
        return {
            'daily': os.path.join(self.base_dir, f'–ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫_{self.current_month}.xlsx'),
            'firms': os.path.join(self.base_dir, f'–§–∏—Ä–º—ã-–∑–∞–∫–∞–∑—á–∏–∫–∏_{self.current_month}.xlsx'),
            'carriers': os.path.join(self.base_dir, f'–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏_{self.current_month}.xlsx')
        }

    def _set_column_widths(self, sheet, widths):
        for col_idx, width in enumerate(widths, 1):
            sheet.column_dimensions[get_column_letter(col_idx)].width = width + 2

    def _apply_header_style(self, cell):
        cell.font = Font(name='Arial', size=12, bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color=self.colors['header'], end_color=self.colors['header'], fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
        cell.border = Border(
            left=Side(style='medium', color='FF666666'),
            right=Side(style='medium', color='FF666666'),
            top=Side(style='medium', color='FF666666'),
            bottom=Side(style='medium', color='FF666666')
        )

    def _apply_cell_style(self, cell, row_num, align='left', number_format=None):
        cell.font = Font(name='Arial', size=10)
        cell.alignment = Alignment(horizontal=align, vertical='center', wrap_text=True)
        color = self.colors['even_row'] if row_num % 2 == 0 else self.colors['odd_row']
        cell.fill = PatternFill(start_color=color, end_color=color, fill_type='solid')
        cell.border = Border(
            left=Side(style='thin', color='FF666666'),
            right=Side(style='thin', color='FF666666'),
            top=Side(style='thin', color='FF666666'),
            bottom=Side(style='thin', color='FF666666')
        )
        if number_format:
            cell.number_format = number_format

    def ensure_files_exist(self):
        files = self.get_file_paths()
        headers = {
            'daily': ['–î–∞—Ç–∞', '–§–∏—Ä–º–∞', '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–í–æ–¥–∏—Ç–µ–ª—å', '–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', '–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥', '–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', '–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫', '–¢–µ–ª–µ—Ñ–æ–Ω', '–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä', '–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', '–¶–µ–Ω–∞', '–û–ø–ª–∞—Ç–∞', '–ü—Ä–æ—á–µ–µ'],
            'firms': ['–î–∞—Ç–∞', '–§–∏—Ä–º–∞', '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–í–æ–¥–∏—Ç–µ–ª—å', '–¶–µ–Ω–∞', '–û–ø–ª–∞—Ç–∞_–æ—Ç_—Ñ–∏—Ä–º—ã', '–î–∞—Ç–∞_–æ–ø–ª–∞—Ç—ã', '–ü—Ä–æ—á–µ–µ'],
            'carriers': ['–î–∞—Ç–∞', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–í–æ–¥–∏—Ç–µ–ª—å', '–û–ø–ª–∞—Ç–∞', '–ù–æ–º–µ—Ä_–ø–ª–∞—Ç–µ–∂–∫–∏', '–î–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞', '–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã', '–ü—Ä–æ—á–µ–µ']
        }
        for file_type, path in files.items():
            if not os.path.exists(path):
                wb = Workbook()
                ws = wb.active
                ws.title = self.current_month
                self._set_column_widths(ws, self.column_widths[file_type])
                for col, header in enumerate(headers[file_type], 1):
                    cell = ws.cell(row=1, column=col, value=header)
                    self._apply_header_style(cell)
                wb.save(path)
                logger.info(f"–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª: {path}")

    def add_record(self, file_path, data, file_type):
        try:
            if not os.path.exists(file_path):
                logger.warning(f"–§–∞–π–ª {file_path} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π")
                self.ensure_files_exist()
            wb = load_workbook(file_path)
            ws = wb.active
            next_row = ws.max_row + 1
            alignments = {
                '–î–∞—Ç–∞': 'center', '–¶–µ–Ω–∞': 'right', '–û–ø–ª–∞—Ç–∞': 'right', '–û–ø–ª–∞—Ç–∞_–æ—Ç_—Ñ–∏—Ä–º—ã': 'right',
                '–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã': 'right', '–ü—Ä–æ—á–µ–µ': 'left'
            }
            number_formats = {
                '–¶–µ–Ω–∞': '#,##0 ‚ÇΩ', '–û–ø–ª–∞—Ç–∞': '#,##0 ‚ÇΩ', '–û–ø–ª–∞—Ç–∞_–æ—Ç_—Ñ–∏—Ä–º—ã': '#,##0 ‚ÇΩ', '–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã': '#,##0 ‚ÇΩ'
            }
            if file_type == 'daily':
                fields = [
                    ('–î–∞—Ç–∞', datetime.now().strftime("%d.%m.%Y")),
                    ('–§–∏—Ä–º–∞', data.get('–§–∏—Ä–º–∞', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')),
                    ('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', data.get('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')),
                    ('–í–æ–¥–∏—Ç–µ–ª—å', data.get('–í–æ–¥–∏—Ç–µ–ª—å', '–ù–µ —É–∫–∞–∑–∞–Ω')),
                    ('–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', data.get('–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', '')),
                    ('–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥', data.get('–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥', '')),
                    ('–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', data.get('–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', '')),
                    ('–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫', data.get('–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫', '')),
                    ('–¢–µ–ª–µ—Ñ–æ–Ω', data.get('–¢–µ–ª–µ—Ñ–æ–Ω', '–ù–µ —É–∫–∞–∑–∞–Ω')),
                    ('–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä', data.get('–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä', '–ù–µ —É–∫–∞–∑–∞–Ω')),
                    ('–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä', data.get('–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä', '–ù–µ —É–∫–∞–∑–∞–Ω')),
                    ('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', data.get('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', '–ù–µ —É–∫–∞–∑–∞–Ω')),
                    ('–¶–µ–Ω–∞', float(data.get('–¶–µ–Ω–∞', 0))),
                    ('–û–ø–ª–∞—Ç–∞', float(data.get('–û–ø–ª–∞—Ç–∞', 0))),
                    ('–ü—Ä–æ—á–µ–µ', data.get('–ü—Ä–æ—á–µ–µ', ''))
                ]
            elif file_type == 'firms':
                fields = [
                    ('–î–∞—Ç–∞', datetime.now().strftime("%d.%m.%Y")),
                    ('–§–∏—Ä–º–∞', data.get('–§–∏—Ä–º–∞', '')),
                    ('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', data.get('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '')),
                    ('–í–æ–¥–∏—Ç–µ–ª—å', data.get('–í–æ–¥–∏—Ç–µ–ª—å', '')),
                    ('–¶–µ–Ω–∞', float(data.get('–¶–µ–Ω–∞', 0))),
                    ('–û–ø–ª–∞—Ç–∞_–æ—Ç_—Ñ–∏—Ä–º—ã', ''),
                    ('–î–∞—Ç–∞_–æ–ø–ª–∞—Ç—ã', ''),
                    ('–ü—Ä–æ—á–µ–µ', data.get('–ü—Ä–æ—á–µ–µ', ''))
                ]
            elif file_type == 'carriers':
                fields = [
                    ('–î–∞—Ç–∞', datetime.now().strftime("%d.%m.%Y")),
                    ('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', data.get('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', '')),
                    ('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', data.get('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '')),
                    ('–í–æ–¥–∏—Ç–µ–ª—å', data.get('–í–æ–¥–∏—Ç–µ–ª—å', '')),
                    ('–û–ø–ª–∞—Ç–∞', float(data.get('–û–ø–ª–∞—Ç–∞', 0))),
                    ('–ù–æ–º–µ—Ä_–ø–ª–∞—Ç–µ–∂–∫–∏', ''),
                    ('–î–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞', ''),
                    ('–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã', float(data.get('–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã', 0))),
                    ('–ü—Ä–æ—á–µ–µ', data.get('–ü—Ä–æ—á–µ–µ', ''))
                ]
            for i, (field, value) in enumerate(fields, 1):
                cell = ws.cell(row=next_row, column=i, value=value)
                self._apply_cell_style(cell, next_row, align=alignments.get(field, 'left'), number_format=number_formats.get(field))
                column = cell.column_letter
                if isinstance(value, str) and ws.column_dimensions[column].width is not None:
                    if len(value) > ws.column_dimensions[column].width:
                        ws.column_dimensions[column].width = len(value) + 2
            wb.save(file_path)
            logger.info(f"–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ {file_path}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤ {file_path}: {e}")
            return False

class YandexDiskUploader:
    def __init__(self, y_disk):
        self.y_disk = y_disk

    def ensure_path_exists(self, path):
        parts = path.strip('/').split('/')
        current_path = ''
        for part in parts:
            if part:
                current_path += f'/{part}'
                if not self.y_disk.exists(current_path):
                    try:
                        self.y_disk.mkdir(current_path)
                        logger.info(f"–°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {current_path}")
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ {current_path}: {e}")
                        raise

    async def upload_files(self, files, message):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏"""
        current_month = datetime.now().strftime("%Y_%m")
        remote_path = f"/TransportData/{current_month}"
        
        try:
            self.ensure_path_exists(remote_path)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: {e}")
            await bot.send_message(chat_id=message.chat.id, text="‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫.")
            return False

        for file_path in files:
            try:
                if not os.path.exists(file_path):
                    logger.error(f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
                    continue

                filename = os.path.basename(file_path)
                remote_file = f"{remote_path}/{filename}"

                if self.y_disk.exists(remote_file):
                    try:
                        self.y_disk.remove(remote_file, permanently=True)
                        logger.info(f"–£–¥–∞–ª—ë–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª: {filename}")
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: {e}")

                self.y_disk.upload(file_path, remote_file, overwrite=True)
                logger.info(f"‚úÖ {filename} –∑–∞–≥—Ä—É–∂–µ–Ω")
                await bot.send_message(chat_id=message.chat.id, text=f"üì§ –§–∞–π–ª {filename} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫!")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {filename}: {e}")
                await bot.send_message(chat_id=message.chat.id, text=f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ {filename} –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫.")
                return False

        return True

def format_company_name(name):
    forms = {'–æ–æ–æ': '–û–û–û', '–æ–∞–æ': '–û–ê–û', '–∑–∞–æ': '–ó–ê–û', '–∏–ø': '–ò–ü', '–ø–∞–æ': '–ü–ê–û', '—Ç–∫': '–¢–ö'}
    name = re.sub(r'\s+', ' ', name.strip())
    words = name.split()
    if not words:
        return name
    first_word = words[0].lower()
    if first_word in forms:
        words[0] = forms[first_word]
        words[1:] = [word.capitalize() for word in words[1:]]
    result = ' '.join(words)
    for form_lower, form_upper in forms.items():
        pattern = fr"(?i){form_lower}\s*([–∞-—è—ë]{2,})"
        result = re.sub(pattern, fr"{form_upper} \1", result)
    return result

def format_phone(phone):
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ —Å—Ç—Ä–æ–∫–∏
    phone = re.sub(r'[^0-9]', '', phone)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    if len(phone) == 11 and phone.startswith('8'):
        return f"+7 ({phone[1:4]}) {phone[4:7]}-{phone[7:9]}-{phone[9:11]}"
    elif len(phone) == 11 and phone.startswith('7'):
        return f"+7 ({phone[1:4]}) {phone[4:7]}-{phone[7:9]}-{phone[9:11]}"
    elif len(phone) == 10:
        return f"+7 ({phone[:3]}) {phone[3:6]}-{phone[6:8]}-{phone[8:10]}"
    return phone

def process_vehicle_number(number):
    return re.sub(r'\W', '', number.upper())

def parse_by_keywords(text):
    """–ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∫–ª—é—á–µ–π"""
    data = {}
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç: –∑–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ–¥–∏–Ω, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
    normalized_text = re.sub(r'\s+', ' ', text.strip()).lower()
    words = normalized_text.split()
    
    i = 0
    current_key = None
    value_parts = []
    
    while i < len(words):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ –∏–ª–∏ –ø–∞—Ä–∞ —Å–ª–æ–≤ –∫–ª—é—á–æ–º
        found_key = None
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∫–ª—é—á–∏ (–∏–∑ –¥–≤—É—Ö —Å–ª–æ–≤)
        if i + 1 < len(words):
            two_words = f"{words[i]} {words[i+1]}"
            found_key = next((k for k, synonyms in KEYWORDS_SYNONYMS.items() if two_words in [s.lower() for s in synonyms]), None)
            if found_key:
                i += 2  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–∞ —Å–ª–æ–≤–∞ –∫–ª—é—á–∞
        # –ï—Å–ª–∏ —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–∏–Ω–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ
        if not found_key:
            found_key = next((k for k, synonyms in KEYWORDS_SYNONYMS.items() if words[i] in [s.lower() for s in synonyms]), None)
            if found_key:
                i += 1  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∫–ª—é—á–∞
        
        if found_key:
            # –ï—Å–ª–∏ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
            if current_key and value_parts:
                data[current_key] = " ".join(value_parts).strip()
                value_parts = []
            current_key = found_key
        else:
            # –ï—Å–ª–∏ —Å–ª–æ–≤–æ –Ω–µ –∫–ª—é—á, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫ –∑–Ω–∞—á–µ–Ω–∏—é —Ç–µ–∫—É—â–µ–≥–æ –∫–ª—é—á–∞
            if current_key:
                value_parts.append(words[i])
            i += 1
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    if current_key and value_parts:
        data[current_key] = " ".join(value_parts).strip()

    logger.debug(f"–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞: {data}")
    return normalize_data(data)

def normalize_data(data):
    for field in ["–§–∏—Ä–º–∞", "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫"]:
        if field in data and data[field]:
            data[field] = format_company_name(data[field])
    if "–í–æ–¥–∏—Ç–µ–ª—å" in data:
        parts = data["–í–æ–¥–∏—Ç–µ–ª—å"].split()
        parts = [part.capitalize() for part in parts[:3]]
        data["–í–æ–¥–∏—Ç–µ–ª—å"] = " ".join(parts)
    if "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" in data:
        parts = re.split(r"[-‚Äì‚Äî‚Üí\s]+", data["–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"])
        parts = [p.strip().title() for p in parts if p.strip()]
        data["–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"] = " ‚Üí ".join(parts)
    if "–ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã" in data:
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º "–ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã" –∏ "–ü—Ä–∏—Ü–µ–ø", –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        vehicle_text = data["–ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã"]
        if "–ü—Ä–∏—Ü–µ–ø" in data:
            vehicle_text += f" –ø—Ä–∏—Ü–µ–ø {data['–ü—Ä–∏—Ü–µ–ø']}"
            del data["–ü—Ä–∏—Ü–µ–ø"]
        parts = vehicle_text.split("–ø—Ä–∏—Ü–µ–ø", 1)
        auto_part = parts[0].strip()
        trailer_part = parts[1].strip() if len(parts) > 1 else ""
        brand_match = re.match(r"(\w+\s*)+", auto_part)
        brand = brand_match.group(0).strip().lower() if brand_match else "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
        data["–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä"] = f"{CAR_BRANDS.get(brand, brand.title())} {process_vehicle_number(auto_part[len(brand):].strip())}"
        data["–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä"] = process_vehicle_number(trailer_part) if trailer_part else "–ù–µ —É–∫–∞–∑–∞–Ω"
    for field in ["–¢–µ–ª–µ—Ñ–æ–Ω"]:
        if field in data:
            data[field] = format_phone(data[field])
    for field in ["–¶–µ–Ω–∞", "–û–ø–ª–∞—Ç–∞"]:
        if field in data:
            try:
                raw_value = data[field]
                if isinstance(raw_value, str):
                    numeric = re.sub(r'[^\d.]', '', raw_value)
                    if '.' in numeric:
                        parts = numeric.split('.')
                        if len(parts) > 2:
                            numeric = ''.join(parts[:-1]) + '.' + parts[-1]
                    data[field] = int(float(numeric) * 1000) if numeric else 0
                else:
                    data[field] = int(raw_value)
            except:
                data[field] = 0
    if "–ü–∞—Å–ø–æ—Ä—Ç" in data:
        passport_text = data["–ü–∞—Å–ø–æ—Ä—Ç"]
        series_match = re.match(r"—Å–µ—Ä–∏—è\s+(\d+\s+\d+)|(\d+\s+\d+\s+‚Ññ\s+\d+)", passport_text, re.IGNORECASE)
        number_match = re.search(r"–Ω–æ–º–µ—Ä\s+(\d+)", passport_text, re.IGNORECASE) if not series_match else None
        issued_match = re.search(r"–≤—ã–¥–∞–Ω\s+(.+?)(?:–¥–∞—Ç–∞\s+–≤—ã–¥–∞—á–∏|\,|\n|$)", passport_text, re.IGNORECASE)
        date_match = re.search(r"–¥–∞—Ç–∞\s+–≤—ã–¥–∞—á–∏:\s*(\d{2}\.\d{2}\.\d{4})", passport_text, re.IGNORECASE) or re.search(r"(\d{2}\.\d{2}\.\d{4})(?:\s*–≥\.)?", passport_text)
        code_match = re.search(r"–∫–æ–¥\s+–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è\s+(\d+-\d+)", passport_text, re.IGNORECASE)

        series_number = series_match.group(0) if series_match else re.match(r"(\d+\s+\d+)", passport_text).group(0) if re.match(r"(\d+\s+\d+)", passport_text) else ""
        number = number_match.group(1) if number_match else re.search(r"‚Ññ\s+(\d+)", passport_text).group(1) if re.search(r"‚Ññ\s+(\d+)", passport_text) else ""
        issued = issued_match.group(1).strip() if issued_match else ""
        date = date_match.group(1) if date_match else ""
        code = code_match.group(1) if code_match else ""

        data["–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä"] = f"{series_number} ‚Ññ {number}" if series_number and number else series_number or ""
        data["–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥"] = f"{issued}, {date}, {code}" if issued or date or code else ""
        data["–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è"] = re.sub(r"\s+‚Ññ\s+\d+", "", series_number).strip() if series_number else ""
        data["–ü–∞—Å–ø–æ—Ä—Ç_–Ω–æ–º–µ—Ä"] = number if number else ""
    if "–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ" in data:
        vu_text = data["–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ"]
        series_match = re.match(r"—Å–µ—Ä–∏—è\s+(\d+\s+\d+)", vu_text, re.IGNORECASE) or re.match(r"(\d+\s+\d+)", vu_text)
        number_match = re.search(r"–Ω–æ–º–µ—Ä\s+(\d+)", vu_text, re.IGNORECASE) or re.search(r"‚Ññ\s+(\d+)", vu_text)
        date_match = re.search(r"–æ—Ç\s+(\d{2}\.\d{2}\.\d{4})", vu_text) or re.search(r"(\d{2}\.\d{2}\.\d{4})(?:\s*–≥\.)?", vu_text)
        term_match = re.search(r"—Å—Ä–æ–∫\s+(\d{2}\.\d{2}\.\d{4}-\d{2}\.\d{2}\.\d{4})", vu_text, re.IGNORECASE)

        series = series_match.group(0) if series_match else ""
        number = number_match.group(1) if number_match else ""
        date = date_match.group(1) if date_match else ""
        term = term_match.group(1) if term_match else ""

        data["–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä"] = f"{series} ‚Ññ {number}" if series and number else series or ""
        data["–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫"] = f"{date}-{term}" if date or term else ""
    return data

def create_main_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìã –ó–∞–ø–∏—Å—å")],
            [KeyboardButton(text="üìÜ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏"), KeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")],
            [KeyboardButton(text="üì¶ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª")]
        ],
        resize_keyboard=True
    )

@dp.message(Command("start"))
async def start_command(message: types.Message, state: FSMContext):
    logger.debug("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start")
    await state.clear()
    await message.reply(
        "üöö –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —É—á–µ—Ç\n\n"
        "–ù–∞–∂–º–∏—Ç–µ 'üìã –ó–∞–ø–∏—Å—å' –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –Ω–∞—á–∏–Ω–∞—è –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —Å –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –§–∏—Ä–º–∞, –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –í–æ–¥–∏—Ç–µ–ª—å –∏ —Ç.–¥.), –∑–∞ –∫–æ—Ç–æ—Ä—ã–º —Å–ª–µ–¥—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π –ø–æ—Ä—è–¥–æ–∫:\n\n"
        "–ü—Ä–∏–º–µ—Ä (–º–æ–∂–Ω–æ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏):\n"
        "–§–∏—Ä–º–∞ –¢–ö –û–ø—Ç–∏–º–∞ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –•–∞–±–∞—Ä–æ–≤—Å–∫ ‚Üí –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ –í–æ–¥–∏—Ç–µ–ª—å –ò–≤–∞–Ω–æ–≤ –ò.–ò. –ü–∞—Å–ø–æ—Ä—Ç 58 23 ‚Ññ 452205 –í/–£ 99 21 ‚Ññ 980427 –¢–µ–ª–µ—Ñ–æ–Ω 911-359-75-34 –ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã –í–æ–ª—å–≤–æ –£444–†–£60 –ü—Ä–∏—Ü–µ–ø –ê–£548647 –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –û–û–û –†–æ–º–∞—à–∫–∞ –¶–µ–Ω–∞ 50000 –û–ø–ª–∞—Ç–∞ 10000\n"
        "–ò–ª–∏:\n"
        "–§–∏—Ä–º–∞: –¢–ö –û–ø—Ç–∏–º–∞\n"
        "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –•–∞–±–∞—Ä–æ–≤—Å–∫-–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫\n"
        "–í–æ–¥–∏—Ç–µ–ª—å: –ò–≤–∞–Ω–æ–≤ –ò.–ò.\n"
        "–ü–∞—Å–ø–æ—Ä—Ç: 58 23 ‚Ññ 452205 –≤—ã–¥–∞–Ω –£–ú–í–î, –¥–∞—Ç–∞ –≤—ã–¥–∞—á–∏: 11.05.2023, –∫–æ–¥ 600-002\n"
        "–í/–£: 99 21 ‚Ññ 980427\n"
        "–¢–µ–ª–µ—Ñ–æ–Ω: 911-359-75-34\n"
        "–ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã: –í–æ–ª—å–≤–æ –£444–†–£60\n"
        "–ü—Ä–∏—Ü–µ–ø: –ê–£548647\n"
        "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫: –û–û–û –†–æ–º–∞—à–∫–∞\n"
        "–¶–µ–Ω–∞: 50000\n"
        "–û–ø–ª–∞—Ç–∞: 10000\n\n"
        "–ï—Å–ª–∏ –¥–æ–ø—É—â–µ–Ω–∞ –æ—à–∏–±–∫–∞, –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç —É—Ç–æ—á–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é.",
        reply_markup=create_main_menu()
    )

@dp.message(lambda message: message.text == "üìã –ó–∞–ø–∏—Å—å")
async def record_start(message: types.Message, state: FSMContext):
    logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: '{message.text}'. –û–∂–∏–¥–∞–µ–º–æ–µ: 'üìã –ó–∞–ø–∏—Å—å'. –°–æ–≤–ø–∞–¥–∞–µ—Ç: {message.text == 'üìã –ó–∞–ø–∏—Å—å'}")
    logger.debug("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ 'üìã –ó–∞–ø–∏—Å—å', —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ Form.text_input")
    await state.set_state(Form.text_input)
    await message.reply(
        "üìù –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –Ω–∞—á–∏–Ω–∞—è –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —Å –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –§–∏—Ä–º–∞, –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –í–æ–¥–∏—Ç–µ–ª—å –∏ —Ç.–¥.), –∑–∞ –∫–æ—Ç–æ—Ä—ã–º —Å–ª–µ–¥—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π –ø–æ—Ä—è–¥–æ–∫:\n\n"
        "–ü—Ä–∏–º–µ—Ä (–º–æ–∂–Ω–æ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏):\n"
        "–§–∏—Ä–º–∞ –¢–ö –û–ø—Ç–∏–º–∞ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –•–∞–±–∞—Ä–æ–≤—Å–∫ ‚Üí –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ –í–æ–¥–∏—Ç–µ–ª—å –ò–≤–∞–Ω–æ–≤ –ò.–ò. –ü–∞—Å–ø–æ—Ä—Ç 58 23 ‚Ññ 452205 –í/–£ 99 21 ‚Ññ 980427 –¢–µ–ª–µ—Ñ–æ–Ω 911-359-75-34 –ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã –í–æ–ª—å–≤–æ –£444–†–£60 –ü—Ä–∏—Ü–µ–ø –ê–£548647 –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –û–û–û –†–æ–º–∞—à–∫–∞ –¶–µ–Ω–∞ 50000 –û–ø–ª–∞—Ç–∞ 10000",
        reply_markup=create_main_menu()
    )

@dp.message(StateFilter(Form.text_input))
async def process_text_input(message: types.Message, state: FSMContext):
    logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ Form.text_input. –ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç: '{message.text.strip()}'")
    text = message.text.strip()
    if not text:
        logger.warning("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç")
        await message.reply(
            "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –Ω–∞—á–∏–Ω–∞—è –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —Å –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –§–∏—Ä–º–∞, –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –í–æ–¥–∏—Ç–µ–ª—å –∏ —Ç.–¥.):",
            reply_markup=create_main_menu()
        )
        return

    try:
        data = parse_by_keywords(text)
        logger.info(f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {data}")

        required_fields = ["–§–∏—Ä–º–∞", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–í–æ–¥–∏—Ç–µ–ª—å", "–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä", "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫", "–¶–µ–Ω–∞", "–û–ø–ª–∞—Ç–∞"]
        missing_fields = [field for field in required_fields if not data.get(field)]
        logger.debug(f"–ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç: {missing_fields}")

        if not missing_fields:
            await show_verification_ui(message, data, state)
        else:
            await message.reply(
                f"‚ö†Ô∏è –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –ø–æ–ª—è: {', '.join(missing_fields)}\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:",
                reply_markup=create_main_menu()
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞: {e}", exc_info=True)
        await message.reply(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
            reply_markup=create_main_menu()
        )

@dp.message(StateFilter(Form.editing_field))
async def update_field(message: types.Message, state: FSMContext):
    logger.debug(f"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç: '{message.text.strip()}'")
    data = await state.get_data()
    field = data.get('editing_field')
    new_value = message.text.strip()

    if field in ["–¶–µ–Ω–∞", "–û–ø–ª–∞—Ç–∞"]:
        try:
            numeric = re.sub(r'[^\d.]', '', new_value)
            if '.' in numeric:
                parts = numeric.split('.')
                if len(parts) > 2:
                    numeric = ''.join(parts[:-1]) + '.' + parts[-1]
            new_value = int(float(numeric) * 1000) if numeric else 0
        except:
            new_value = 0

    if field == "–¢–µ–ª–µ—Ñ–æ–Ω":
        new_value = format_phone(new_value)
    elif field in ["–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä", "–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä"]:
        new_value = process_vehicle_number(new_value)
    elif field in ["–§–∏—Ä–º–∞", "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫"]:
        new_value = format_company_name(new_value)
    elif field == "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ":
        parts = re.split(r"[-‚Äì‚Äî‚Üí\s]+", new_value)
        parts = [p.strip().title() for p in parts if p.strip()]
        new_value = " ‚Üí ".join(parts)

    data['temp_data'][field] = new_value
    await state.update_data(temp_data=data['temp_data'])
    await state.set_state(Form.text_input)
    await show_verification_ui(message, data['temp_data'], state)

@dp.message(lambda message: message.text and not message.text.startswith('/'))
async def handle_unexpected_text(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    logger.debug(f"–ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç –≤–Ω–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –¢–µ–∫—Å—Ç: '{message.text}'. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {current_state}")
    if current_state != Form.text_input.state and current_state != Form.editing_field.state:
        await message.reply(
            "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ 'üìã –ó–∞–ø–∏—Å—å', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö.",
            reply_markup=create_main_menu()
        )

async def show_verification_ui(message: types.Message, data: dict, state: FSMContext):
    logger.debug("–ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö")
    builder = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="‚úÖ –í–µ—Ä–Ω–æ", callback_data="confirm_yes"),
            InlineKeyboardButton(text="‚ùå –ù–µ–≤–µ—Ä–Ω–æ", callback_data="confirm_no")
        ]
    ])
    formatted_data = "üìã –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n\n"
    if "–í–æ–¥–∏—Ç–µ–ª—å" in data:
        formatted_data += f"{hbold('–í–æ–¥–∏—Ç–µ–ª—å')}:\n"
        formatted_data += f"  - –§–ò–û: {data.get('–í–æ–¥–∏—Ç–µ–ª—å', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"
        if "–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä" in data and data["–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä"]:
            formatted_data += f"  - –ü–∞—Å–ø–æ—Ä—Ç: {data.get('–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', '')}\n"
        if "–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥" in data and data["–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥"]:
            formatted_data += f"  - –ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥: {data.get('–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥', '')}\n"
        if "–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä" in data and data["–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä"]:
            formatted_data += f"  - –í/–£: {data.get('–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä', '')}\n"
        if "–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫" in data and data["–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫"]:
            formatted_data += f"  - –í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫: {data.get('–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫', '')}\n"
        if "–¢–µ–ª–µ—Ñ–æ–Ω" in data and data["–¢–µ–ª–µ—Ñ–æ–Ω"] != "–ù–µ —É–∫–∞–∑–∞–Ω":
            formatted_data += f"  - –¢–µ–ª–µ—Ñ–æ–Ω: {data.get('–¢–µ–ª–µ—Ñ–æ–Ω', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"
        if "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" in data and data["–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è"]:
            formatted_data += f"  - –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {data.get('–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è', '')}\n"
        if "–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" in data and data["–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"]:
            formatted_data += f"  - –ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {data.get('–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', '')}\n"
    for key in ["–§–∏—Ä–º–∞", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫", "–¶–µ–Ω–∞", "–û–ø–ª–∞—Ç–∞"]:
        if key in data and data[key]:
            formatted_data += f"{hbold(key)}: {data.get(key, '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"
    if "–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä" in data or "–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä" in data:
        formatted_data += f"{hbold('–ú–∞—Ä–∫–∞ –º–∞—à–∏–Ω—ã')}:\n"
        if "–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä" in data and data["–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä"] != "–ù–µ —É–∫–∞–∑–∞–Ω":
            formatted_data += f"  - –ê–≤—Ç–æ–º–æ–±–∏–ª—å: {data.get('–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"
        if "–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä" in data and data["–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä"] != "–ù–µ —É–∫–∞–∑–∞–Ω":
            formatted_data += f"  - –ü—Ä–∏—Ü–µ–ø: {data.get('–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"

    await message.reply(
        formatted_data,
        reply_markup=builder,
        parse_mode="HTML"
    )
    await state.update_data(temp_data=data)

@dp.callback_query(lambda c: c.data == "confirm_yes")
async def handle_correct(callback: types.CallbackQuery, state: FSMContext):
    logger.debug("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –¥–∞–Ω–Ω—ã–µ (‚úÖ –í–µ—Ä–Ω–æ)")
    data = await state.get_data()
    await save_record(callback.message, state, data["temp_data"])
    await callback.answer()

@dp.callback_query(lambda c: c.data == "confirm_no")
async def handle_incorrect(callback: types.CallbackQuery, state: FSMContext):
    logger.debug("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –¥–∞–Ω–Ω—ã–µ (‚ùå –ù–µ–≤–µ—Ä–Ω–æ), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
    data = await state.get_data()
    builder = InlineKeyboardMarkup(inline_keyboard=[])
    field_groups = [
        ["–§–∏—Ä–º–∞", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫"],
        ["–í–æ–¥–∏—Ç–µ–ª—å"],
        ["–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä", "–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥", "–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä", "–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫", "–¢–µ–ª–µ—Ñ–æ–Ω", "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è", "–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"],
        ["–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä", "–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä"],
        ["–¶–µ–Ω–∞", "–û–ø–ª–∞—Ç–∞"]
    ]
    for group in field_groups:
        row_buttons = []
        for field in group:
            if field in data["temp_data"] and (field != "–ü—Ä–æ—á–µ–µ" or data["temp_data"].get(field)):
                row_buttons.append(
                    InlineKeyboardButton(
                        text=f"‚úèÔ∏è {field}",
                        callback_data=f"reedit_{field}"
                    )
                )
        if row_buttons:
            builder.inline_keyboard.append(row_buttons)
    await callback.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:",
        reply_markup=builder
    )

@dp.callback_query(lambda c: c.data.startswith("reedit_"))
async def reedit_field(callback: types.CallbackQuery, state: FSMContext):
    field = callback.data.split("_")[1]
    logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—è: {field}")
    await state.update_data(editing_field=field)
    await state.set_state(Form.editing_field)
    
    hints = {
        "–§–∏—Ä–º–∞": "–¢–ö –û–ø—Ç–∏–º–∞",
        "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–ú–æ—Å–∫–≤–∞ ‚Üí –ü–∏—Ç–µ—Ä",
        "–í–æ–¥–∏—Ç–µ–ª—å": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
        "–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä": "58 23 ‚Ññ 452205",
        "–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥": "–£–ú–í–î, 11.05.2023, 600-002",
        "–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä": "99 21 ‚Ññ 980427",
        "–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫": "12.05.2021-24.09.2030",
        "–¢–µ–ª–µ—Ñ–æ–Ω": "911-359-75-34",
        "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è": "01.01.1990",
        "–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏": "–ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥.1",
        "–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä": "Volvo –£444–†–£60",
        "–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä": "–ê–£548647",
        "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫": "–û–û–û –†–æ–º–∞—à–∫–∞",
        "–¶–µ–Ω–∞": "50000",
        "–û–ø–ª–∞—Ç–∞": "10000"
    }
    
    await callback.message.answer(
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è <b>{field}</b> (–ø—Ä–∏–º–µ—Ä: {hints.get(field, '')})",
        parse_mode="HTML"
    )

@dp.message(lambda message: message.text == "üìÜ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏")
async def show_last_records(message: types.Message):
    logger.debug("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ 'üìÜ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏'")
    await message.reply("–§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.", reply_markup=create_main_menu())

@dp.message(lambda message: message.text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def show_statistics(message: types.Message):
    logger.debug("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'")
    try:
        excel_manager = ExcelManager(LOCAL_TEMP_DIR)
        daily_file = excel_manager.get_file_paths()['daily']
        if not os.path.exists(daily_file):
            await message.reply("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö", 
                               reply_markup=create_main_menu())
            return

        wb = load_workbook(daily_file)
        ws = wb.active
        total_records = ws.max_row - 1

        total_amount = 0
        total_payment = 0
        for row in ws.iter_rows(min_row=2, max_col=14, values_only=True):
            total_amount += row[12] if row[12] else 0
            total_payment += row[13] if row[13] else 0

        stats = (
            "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:</b>\n\n"
            f"üöö –í—Å–µ–≥–æ –ø–µ—Ä–µ–≤–æ–∑–æ–∫: {total_records}\n"
            f"üí∞ –û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤: {total_amount:,.0f} ‚ÇΩ\n"
            f"üí∏ –û–±—â–∞—è —Å—É–º–º–∞ –≤—ã–ø–ª–∞—Ç: {total_payment:,.0f} ‚ÇΩ\n"
            f"‚öñÔ∏è –°—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞: {(total_amount - total_payment)/total_records:,.0f} ‚ÇΩ" if total_records > 0 else "‚öñÔ∏è –°—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞: 0 ‚ÇΩ"
        )
        await message.reply(stats, parse_mode="HTML",
                           reply_markup=create_main_menu())
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
        await message.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                           reply_markup=create_main_menu())

async def save_record(message: types.Message, state: FSMContext, data: dict):
    logger.debug("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏")
    defaults = {
        "–§–∏—Ä–º–∞": "–ù–µ —É–∫–∞–∑–∞–Ω–∞",
        "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
        "–í–æ–¥–∏—Ç–µ–ª—å": "–ù–µ —É–∫–∞–∑–∞–Ω",
        "–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä": "",
        "–ü–∞—Å–ø–æ—Ä—Ç_–º–µ—Å—Ç–æ_–≤—ã–¥–∞—á–∏_–¥–∞—Ç–∞_–∫–æ–¥": "",
        "–í/–£_—Å–µ—Ä–∏—è_–∏_–Ω–æ–º–µ—Ä": "",
        "–í/–£_–¥–∞—Ç–∞_—Å—Ä–æ–∫": "",
        "–¢–µ–ª–µ—Ñ–æ–Ω": "–ù–µ —É–∫–∞–∑–∞–Ω",
        "–ú–∞—Ä–∫–∞_–º–∞—à–∏–Ω—ã_–Ω–æ–º–µ—Ä": "–ù–µ —É–∫–∞–∑–∞–Ω",
        "–ü—Ä–∏—Ü–µ–ø_–Ω–æ–º–µ—Ä": "–ù–µ —É–∫–∞–∑–∞–Ω",
        "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫": "–ù–µ —É–∫–∞–∑–∞–Ω",
        "–¶–µ–Ω–∞": 0,
        "–û–ø–ª–∞—Ç–∞": 0
    }
    data = {**defaults, **data}

    excel_manager = ExcelManager(LOCAL_TEMP_DIR)
    excel_manager.ensure_files_exist()
    success = excel_manager.add_record(
        excel_manager.get_file_paths()['daily'],
        data,
        'daily'
    )

    if success:
        uploader = YandexDiskUploader(y_disk)
        upload_success = await uploader.upload_files(
            list(excel_manager.get_file_paths().values()),
            message
        )

        status = "‚úÖ –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞" + (
            " –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫" if upload_success else ", –Ω–æ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –Ω–µ —É–¥–∞–ª–∞—Å—å"
        )
    else:
        status = "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"

    await message.reply(status, reply_markup=create_main_menu())
    await state.clear()

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        if not y_disk.check_token():
            logger.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞")
            return
        await dp.start_polling(bot)
    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    finally:
        await bot.session.close()

if __name__ == "__main__":
    if os.name == 'nt':
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    asyncio.run(main())